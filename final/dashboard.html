<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Smart Waste Ops Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: system-ui, Arial; display:flex; height:100vh; }
    #left { width:360px; border-right:1px solid #eee; display:flex; flex-direction:column; }
    #map { flex:1; }
    header { padding:12px; background:#0f172a; color:#fff; font-weight:700; }
    .section { flex:1; overflow:auto; }
    .tab-buttons { display:flex; border-bottom:1px solid #eee; }
    .tab-buttons button { flex:1; padding:8px; border:none; background:#f7f7f7; cursor:pointer; }
    .tab-buttons button.active { background:#fff; font-weight:600; }
    .item { padding:8px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
    .item:hover { background:#f7f7f7; }
    .item-title { font-weight:600; }
    .item-detail { font-size:12px; color:#555; }
    .controls { padding:8px; border-top:1px solid #eee; font-size:12px; }
    .toast { position:absolute; top:12px; right:12px; z-index:9999; background:#22c55e; color:#fff; padding:8px 12px; border-radius:6px; display:none; }
    .collect-btn { background-color: #2563eb; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .collect-btn:hover { background-color: #1d4ed8; }

    /* Popup and Progress Bar Styles */
    .leaflet-popup-content-wrapper { border-radius: 8px; }
    .popup-content { font-size: 14px; }
    .popup-content h4 { margin: 0 0 10px; }
    .progress-bar-container { margin-bottom: 8px; }
    .progress-bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; color: #334155; }
    .progress-bar { width: 100%; background-color: #e2e8f0; border-radius: 4px; height: 16px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background-color: #4ade80; border-radius: 4px; text-align: center; color: white; font-size: 10px; line-height: 16px; }
    .progress-bar-fill.medium { background-color: #facc15; }
    .progress-bar-fill.high { background-color: #f87171; }
  </style>
</head>
<body>
  <div id="left">
    <header>Smart Waste Management â€“ Kandy</header>

    <div style="padding:10px; background:#f7f7f7; border-bottom:1px solid #eee;">
      <a href="analytics.html" style="color:#2563eb; text-decoration:none; font-weight:600; border:1.5px solid #2563eb; padding:6px 14px; border-radius:6px; display:inline-block;">ðŸ“Š View Analytics</a>
    </div>

    <div class="section">
      <div class="tab-buttons">
        <button id="tabBins" class="active">Bins</button>
        <button id="tabTrucks">Trucks</button>
        <button id="tabAlerts">Alerts</button>
        <button id="tabSchedule">Schedule</button>
      </div>
      <div id="tabContentBins"><h4>Active Bins</h4><div id="binList"></div></div>
      <div id="tabContentTrucks" style="display:none;"><h4>Fleet Trucks</h4><div id="truckList"></div></div>
      <div id="tabContentAlerts" style="display:none;"><h4>Recent Alerts</h4><div id="alertList"></div></div>
      <div id="tabContentSchedule" style="display:none;"><h4>Collection Schedule ( 6 AM To 10 Am )</h4><div id="scheduleList"></div></div>
    </div>

    <div class="controls">
      Routes via OpenRouteService <br/>
      <button id="routeNearestBtn" class="collect-btn">Route to nearest 5 bins</button>
    </div>
  </div>

  <div id="map"></div>
  <div id="toast" class="toast"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

  <script>
    // ---------- CONFIG ----------
    const HIVE_MQ_WS = 'wss://47009d7316b04ed9a5120c96c6b40fe6.s1.eu.hivemq.cloud:8884/mqtt';
    const HIVE_USER = 'newiot';
    const HIVE_PASS = 'iotPass123321@#';
    const ORS_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImQwYTFkOGY4MWJhYjQxMWVhN2ViMGU3OTk1NzIzZTQ4IiwiaCI6Im11cm11cjY0In0=';

    const TOPICS = {
      TRUCK: 'fleet/+/gps',
      ULTRA: 'fleet/+/ultrasonic',
      DHT: 'fleet/+/dht',
      MPU: 'alerts/flip',
      HX711: 'fleet/+/hx711'
    };

    const firebaseConfig = {
  apiKey: "AIzaSyBz-GtcAXc0V6y_KqRKI7DA5N22X4j-TYc",
  authDomain: "iot-analytics-98402.firebaseapp.com",
  projectId: "iot-analytics-98402",
  storageBucket: "iot-analytics-98402.firebasestorage.app",
  messagingSenderId: "270076650507",
  appId: "1:270076650507:web:054b29d4d9d8e83a51d30e"
    };

    // ---------- STATE ----------
    const staticBins = [
      { id: 'BIN_K01', name: 'Bin K01', lat: 7.2906, lon: 80.6337 },
      { id: 'BIN_K02', name: 'Bin K02', lat: 7.2936, lon: 80.6410 },
      { id: 'BIN_K03', name: 'Bin K03', lat: 7.2855, lon: 80.6376 },
      { id: 'BIN_A08', name: 'Bin A08', lat: 7.2958, lon: 80.6352 },
      { id: 'BIN_C14', name: 'Bin C14', lat: 7.2881, lon: 80.6459 }
    ];
    const bins = {}, trucks = {}, markers = {}, alerts = [];
    let map, binLayer, truckLayer, routeLayer, openBinDetailId = null, db;

    // ---------- INIT FIREBASE ----------
    if (firebaseConfig.apiKey === "YOUR_API_KEY") {
        alert("Firebase configuration is missing. Please edit dashboard.html to add your project credentials.");
    } else {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    }

    function saveToFirestore(collection, data) {
      if (!db) return;
      db.collection(collection).add(data).catch(console.error);
    }

    // ---------- MAP ----------
    function initMap() {
      map = L.map('map').setView([7.2906, 80.6337], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      binLayer = L.layerGroup().addTo(map);
      truckLayer = L.layerGroup().addTo(map);
      routeLayer = L.layerGroup().addTo(map);

      staticBins.forEach(b => {
        const m = L.circleMarker([b.lat, b.lon], { radius:8, color:'#2b6cb0' }).addTo(binLayer);
        m.bindPopup(`<b>${b.name}</b><br/>${b.id}`);
        markers[b.id] = m;
      });
    }

    // ---------- MQTT ----------
    const client = mqtt.connect(HIVE_MQ_WS, {
      username: HIVE_USER,
      password: HIVE_PASS,
      clientId: 'webdash_' + Math.random().toString(16).slice(2),
      reconnectPeriod: 3000
    });

    client.on('connect', () => {
      console.log('MQTT connected');
      Object.values(TOPICS).forEach(t => client.subscribe(t));
    });

    client.on('message', (topic, msg) => {
      let payload; try { payload = JSON.parse(msg.toString()); } catch { return; }

      if (topic.includes('/ultrasonic')) {
        const binId = payload.bin_id || 'unknown';
        bins[binId] = { ...bins[binId], ...payload };
        updateBinList(); updateScheduleList(); updateBinDetailIfOpen();
      }
      else if (topic.includes('/gps')) {
        const truckId = topic.split('/')[1];
        trucks[truckId] = payload;
        updateTruckList(); updateTruckMarker(truckId, payload);
        saveToFirestore('gps_data', { ...payload, truckId });
      }
      else if (topic.includes('/dht')) {
        const truckId = topic.split('/')[1];
        trucks[truckId] = { ...trucks[truckId], ...payload };
        updateTruckList();
        saveToFirestore('dht_data', { ...payload, truckId });
      }
      else if (topic.includes('/mpu') || topic === 'alerts/flip') {
        showToast(`Flip alert: ${payload.bin_id || payload.truckId || 'unknown'}`, true);
        alerts.push({ ...payload, type:'Flip Alert' });
        updateAlertList();
        saveToFirestore('alerts', { ...payload, type:'Flip Alert' });
      }
      else if (topic.includes('/hx711')) {
        const binId = payload.bin_id || 'unknown';
        bins[binId] = { ...bins[binId], ...payload };
        updateBinDetailIfOpen();
      }
    });

    // ---------- UI ----------
    function showTab(tab) {
      ['Bins','Trucks','Alerts', 'Schedule'].forEach(t => {
        document.getElementById(`tabContent${t}`).style.display = (tab === t.toLowerCase()) ? '' : 'none';
        document.getElementById(`tab${t}`).classList.toggle('active', tab === t.toLowerCase());
      });
    }
    document.getElementById('tabBins').onclick = ()=>showTab('bins');
    document.getElementById('tabTrucks').onclick = ()=>showTab('trucks');
    document.getElementById('tabAlerts').onclick = ()=>showTab('alerts');
    document.getElementById('tabSchedule').onclick = ()=>showTab('schedule');

    function updateBinList() {
      const el = document.getElementById('binList'); el.innerHTML='';
      staticBins.forEach(b => {
        const d = bins[b.id] || {};
        const item = document.createElement('div');
        item.className='item';
        item.onclick=()=>showBinDetail(b.id);
        item.innerHTML = `<div>
            <div class="item-title">${b.name}</div>
            <div class="item-detail">${d.distance_cm ? d.distance_cm+' cm':'no data'}</div>
          </div><div style="font-size:12px;color:#666">${d.ts?timeAgo(d.ts):''}</div>`;
        el.appendChild(item);
      });
    }

    function updateTruckList() {
      const el = document.getElementById('truckList'); el.innerHTML='';
      Object.entries(trucks).forEach(([id,t])=>{
        const item = document.createElement('div');
        item.className='item';
        item.innerHTML=`<div><div class="item-title">${id}</div>
          <div class="item-detail">${t.speed_kmh?t.speed_kmh+' km/h':''} ${t.temp_c?'| '+t.temp_c+'Â°C':''}</div></div>
          <div style="font-size:12px;color:#666">${t.ts?timeAgo(t.ts):''}</div>`;
        el.appendChild(item);
      });
    }

    function updateAlertList() {
      const el = document.getElementById('alertList'); el.innerHTML='';
      if(alerts.length===0){ el.innerHTML='<div style="color:#888;padding:8px;">No alerts yet.</div>'; return; }
      alerts.slice(-20).reverse().forEach(a=>{
        const item=document.createElement('div');
        item.className='item';
        item.innerHTML=`<b>${a.type}</b> - ${a.bin_id||a.truckId||''} <span style="color:#555;">${a.ts?timeAgo(a.ts):''}</span>`;
        el.appendChild(item);
      });
    }

    function updateScheduleList() {
        const el = document.getElementById('scheduleList'); el.innerHTML = '';
        // For demo, all static bins are on the schedule
        staticBins.forEach(b => {
            const d = bins[b.id] || {};
            const fillLevel = d.distance_cm ? Math.min(100, Math.max(0, 100 - (d.distance_cm / 50 * 100))) : 0;
            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `
                <div>
                    <div class="item-title">${b.name}</div>
                    <div class="item-detail">Current Fill: <strong>${fillLevel.toFixed(0)}%</strong></div>
                </div>
                <button class="collect-btn" onclick="collectBin('${b.id}', ${fillLevel})">Collect</button>
            `;
            el.appendChild(item);
        });
    }

    function collectBin(binId, fillLevel) {
        const binData = bins[binId] || {};
        const log = {
            action: 'collected',
            bin_id: binId,
            timestamp: new Date(),
            fill_level_at_collection: binData.distance_cm ? Math.min(100, Math.max(0, 100 - (binData.distance_cm / 50 * 100))) : 0,
            weight_kg: binData.weight_kg || null,
            temp_c: binData.temp_c || null
        };

        saveToFirestore('collections', log);
        showToast(`Collected data for ${binId}.`);
        console.log("Logged collection:", log);
    }

    function showBinDetail(binId){ openBinDetailId=binId; renderBinDetail(binId); }
    function renderBinDetail(binId){
        const b = staticBins.find(x => x.id === binId), d = bins[binId] || {};
        const fillLevel = d.distance_cm ? Math.min(50, Math.max(0, 50 - (d.distance_cm / 25 * 50))) : 0;
        const weight = d.weight_kg ? d.weight_kg : 0;
        const temp = d.temp_c ? d.temp_c : 0;

        const fillClass = fillLevel > 75 ? 'high' : fillLevel > 50 ? 'medium' : 'low';
        const weightMax = 50; // Assume max weight of 50kg for progress bar
        const tempMax = 50; // Assume max temp of 50C for progress bar

        const html = `
            <div class="popup-content">
                <h4>${b.name}</h4>
                <div class="progress-bar-container">
                    <div class="progress-bar-label"><span>Fill Level</span><span>${fillLevel.toFixed(0)}%</span></div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill ${fillClass}" style="width: ${fillLevel}%;"></div>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-label"><span>Weight</span><span>${weight.toFixed(2)} kg</span></div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: ${Math.min(100, (weight/weightMax)*100)}%;"></div>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-label"><span>Temperature</span><span>${temp} Â°C</span></div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: ${Math.min(100, (temp/tempMax)*100)}%;"></div>
                    </div>
                </div>
                <div style="font-size:10px; color:#777; margin-top:10px;">Last updated: ${d.ts ? timeAgo(d.ts) : 'N/A'}</div>
            </div>
        `;
        L.popup({ minWidth: 280 }).setLatLng([b.lat, b.lon]).setContent(html).openOn(map);
    }
    function updateBinDetailIfOpen(){ if(openBinDetailId) renderBinDetail(openBinDetailId); }

    function updateTruckMarker(id, payload) {
      if (typeof payload.lat !== 'number' || typeof payload.lon !== 'number') return;
      if (markers['truck_' + id]) {
        markers['truck_' + id].setLatLng([payload.lat, payload.lon]);
      } else {
        const truckMarker = L.circleMarker([payload.lat, payload.lon], { radius: 8, color: '#c05621', weight: 2, interactive: true }).addTo(truckLayer);
        truckMarker.bindPopup(`<b>${id}</b>`);
        truckMarker.on('click', () => map.setView([payload.lat, payload.lon], 15));
        markers['truck_' + id] = truckMarker;
      }
    }

    function showToast(msg, isError = false){
        const t=document.getElementById('toast');
        t.innerText=msg;
        t.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
        t.style.display='block';
        setTimeout(()=>t.style.display='none', 4000);
    }

    // ---------- ROUTING ----------
    async function calculateAndShowRoute() {
        if (ORS_KEY === 'YOUR_OPENROUTESERVICE_KEY' || !ORS_KEY) {
            return showToast('OpenRouteService API key is not configured.', true);
        }
        if (Object.keys(trucks).length === 0) {
            return showToast('No truck data available to calculate a route.', true);
        }

        const firstTruckId = Object.keys(trucks)[0];
        const truck = trucks[firstTruckId];
        if (typeof truck.lat !== 'number' || typeof truck.lon !== 'number') {
            return showToast(`Truck ${firstTruckId} has no location data.`, true);
        }

        showToast('Calculating route to nearest 5 bins...');
        const startCoord = [truck.lon, truck.lat];
        const binsWithDistance = staticBins.map(bin => {
            const distance = getDistance(truck.lat, truck.lon, bin.lat, bin.lon);
            return { ...bin, distance };
        }).sort((a, b) => a.distance - b.distance);

        const nearest5Bins = binsWithDistance.slice(0, 5);
        const coordinates = [startCoord, ...nearest5Bins.map(b => [b.lon, b.lat])];

        try {
            const response = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
                method: 'POST',
                headers: {
                    'Authorization': ORS_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ coordinates })
            });

            if (!response.ok) {
                const err = await response.json();
                const message = (err && err.error && err.error.message) ? err.error.message : 'ORS API error';
                throw new Error(message);
            }

            const routeData = await response.json();
            const routeCoords = routeData.features[0].geometry.coordinates.map(c => [c[1], c[0]]); // Flip for Leaflet

            routeLayer.clearLayers();
            const routeLine = L.polyline(routeCoords, { color: '#2563eb', weight: 5 }).addTo(routeLayer);
            map.fitBounds(routeLine.getBounds());
            showToast('Route calculated and displayed.');
        } catch (error) {
            console.error('Route calculation error:', error);
            showToast(`Failed to calculate route: ${error.message}`, true);
        }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // ---------- UTILS ----------
    function timeAgo(ts){ if(!ts)return''; const s=Math.floor((Date.now()-new Date(ts).getTime())/1000); if(s<60)return s+'s'; if(s<3600)return Math.floor(s/60)+'m'; if(s<86400)return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d'; }

    // ---------- INIT ----------
    initMap();
    updateBinList();
    updateTruckList();
    updateAlertList();
    updateScheduleList();
    showTab('bins');
    document.getElementById('routeNearestBtn').onclick = calculateAndShowRoute;
  </script>
</body>
</html>
